https://middlewaretechnologies.in/2022/01/how-to-authenticate-a-normal-user-with-client-certificate-in-kubernetes.html

root@client:~# openssl genrsa -out piotr.key 2048

root@client:~# openssl req -new -key piotr.key -out piotr.csr
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [AU]:PL
State or Province Name (full name) [Some-State]:lodzkie
Locality Name (eg, city) []:Lodz
Organization Name (eg, company) [Internet Widgits Pty Ltd]:developer
Organizational Unit Name (eg, section) []:developer
Common Name (e.g. server FQDN or YOUR name) []:piotr
Email Address []:piotr@company.com

Please enter the following 'extra' attributes
to be sent with your certificate request
A challenge password []:
An optional company name []:


root@client:~# cat piotr.csr | base64 | tr -d "\n"

apiVersion: certificates.k8s.io/v1
kind: CertificateSigningRequest
metadata:
  name: piotr 
spec:
  request: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURSBSRVFVRVNULS0tLS0KTUlJQzF6Q0NBYjhDQVFBd2daRXhDekFKQmdOVkJBWVRBbEJNTVJBd0RnWURWUVFJREFkc2IyUjZhMmxsTVEwdwpDd1lEVlFRSERBUk1iMlI2TVJJd0VBWURWUVFLREFsa1pYWmxiRzl3WlhJeEVqQVFCZ05WQkFzTUNXUmxkbVZzCmIzQmxjakVPTUF3R0ExVUVBd3dGY0dsdmRISXhLVEFuQmdrcWhraUc5dzBCQ1FFV0duQnBiM1J5TG1Gc1pXdHoKYm1sdVFHWjFhbWwwYzNVdVkyOXRNSUlCSWpBTkJna3Foa2lHOXcwQkFRRUZBQU9DQVE4QU1JSUJDZ0tDQVFFQQp2ZjNkaVByMXhoU21QS29lRHZlOVBZZWcwSVJIRnZHRC80K1g1M0o1eUFSOU52eTlJSGtjQnl4QWVPUFkvMTc2CnFKWmp2SU0zVzQ2Z28rS1lYKzRSVXd3azhyay90WXR3c2RnT201dTBERWpJVWtkS3FRb0RGUGJkblRaT2JMTXgKdjJjdzk0N2hnMFY2VW0wYzZmV2JTNFoxMWdJcUtTYlZWTmRFU3VkMzN5TFF5R1ptTlpmV251S1FZRnlVb2p0TQpZOXE0Vy91RjJwZ2RlUXJTcjhxYkg5UTF0aVVqRE1jV2dldU53SFpCaTl4MWw0Z1ljYXA3UExWUmFPTEZndGQ0CkpjSGZTNS9YcG9PUExVYy9ZTnlFdXRPcUUxQ3ZPU3VvZGJzUmJ5a3F4Tzl0dHN2RlRrNDNoV2lwZkgxOWtBNCsKZjNVWHlFRDFHa2dxdkQ1QStOYzhjd0lEQVFBQm9BQXdEUVlKS29aSWh2Y05BUUVMQlFBRGdnRUJBQjVLVDZ0VQptci9rSndvcWN5SUovNmFwejFKK1BSV0U5Q3dJRFRLSUJydVgwYUFTMlo4UFRHazFaK0ZmZ05yK2tPbmpVZG5CCnp3R2N6VGlwTW5RZWxjMjh1Uk1od25pNjhpdkJtSnJtV3gzclVkbGhPMWNnRTFJL01OaUkveWJQODJWS2Y0R2oKdWtvZ2ZFZnE1UGRIZ0k3QUo4Z2E3bmdrcU01eWtzajRoSDF6YlcrZ3ZIZ2Y5aHlXeXRmcVI5cmM1Z1JlTUtGMApVZ2xsT0RpR2pRYzY4M3RqN0cxN1VKdXNOWVRTVU1obmtqNEpBa1UxL2l1TzFHcDBaMmlkSUl3YlZDWXd2U3FSCmQzYUpLa3hBQXMwZkJnNW1teFJxY3RueFZuVnhvN1QwZ0lvNTQrRGF4R0VnM01pVVdRWXVKR3V6VFlRbFBIbkcKejF2MTlGejVweEVsYkdFPQotLS0tLUVORCBDRVJUSUZJQ0FURSBSRVFVRVNULS0tLS0K
  signerName: kubernetes.io/kube-apiserver-client
  expirationSeconds: 86400  # one day
  usages:
  - client auth



root@ubuntu-4gb-hel1-1:~# kubectl apply -f csr.yaml
root@ubuntu-4gb-hel1-1:~# kubectl get csr

root@ubuntu-4gb-hel1-1:~# kubectl certificate approve piotr
root@ubuntu-4gb-hel1-1:~# kubectl get csr piotr -o jsonpath='{.status.certificate}' | base64 -d > piotr.crt
root@ubuntu-4gb-hel1-1:~# kubectl create role developer --verb=create --verb=get --verb=list --verb=update --verb=delete --resource=pods

root@ubuntu-4gb-hel1-1:~# kubectl get role developer -o yaml
root@ubuntu-4gb-hel1-1:~# kubectl create rolebinding developer-binding-piotr --role=developer --user=piotr
root@ubuntu-4gb-hel1-1:~# kubectl config set-credentials piotr --client-key=piotr.key --client-certificate=piotr.crt --embed-certs=true
root@ubuntu-4gb-hel1-1:~# kubectl config set-context piotr --cluster=kubernetes --user=piotr
root@ubuntu-4gb-hel1-1:~# kubectl config use-context piotr
root@ubuntu-4gb-hel1-1:~# kubectl config get-contexts


------------------------------------------------


apiVersion: v1
kind: Config

clusters:
- cluster:
    proxy-url: http://proxy.example.org:3128
    server: https://k8s.example.org/k8s/clusters/c-xxyyzz
  name: development

users:
- name: developer

contexts:
- context:
  name: development
  
  
 -----------------------------------------------
 
 
apiVersion: v1
clusters:
- cluster:
    certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUMvakNDQWVhZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwcmRXSmwKY201bGRHVnpNQjRYRFRJeU1EY3hNekU0TURJeU0xb1hEVE15TURjeE1ERTRNREl5TTFvd0ZURVRNQkVHQTFVRQpBeE1LYTNWaVpYSnVaWFJsY3pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTDZVCjh1eURzZGZ5bkUzN1hmNyt0VnUxbkRjNjJnRkxESVh4SnVuZzZOeFdITFhzSFR0akxacDRSVUovNXhFSnBJbEMKU1NuQnhPVFk2UlhiR1FENWRNdWx4eldmTlRLd0dwNnZLUEI1Yy9aSWZZa1FySVpDanAyVGU0ZXcxYXhvNGUzUQpUSjI4Ukk5Q28ycEN2UHY3WlQ1dDl2LytWanJsQmhnbTVLOTV2UHhLa3JSNll4MXdTWTdKRDFNaXBkQjBhZ2ZLCmVpdkNYTjBwS0plclEzSHJnVGY0angxU1JsblE4WEZucVh3WXhDMG4xSkl5QjJDeE5qTlVFQ1ExRGwzenRrMm8KQTNRV0UvRDEvMkNtRGpLNitNNHliUm1ZVXRxZEFpV3BYVnhmUENUVXMvYUR6UUZHNXZvbjRPVmlmV21aRVZEbApxa21wSnJpbzJnbkpYaTAxV2JjQ0F3RUFBYU5aTUZjd0RnWURWUjBQQVFIL0JBUURBZ0trTUE4R0ExVWRFd0VCCi93UUZNQU1CQWY4d0hRWURWUjBPQkJZRUZLVU85YS9hQkRxMUVjeU4zQXFQa3J5SmpmUGtNQlVHQTFVZEVRUU8KTUF5Q0NtdDFZbVZ5Ym1WMFpYTXdEUVlKS29aSWh2Y05BUUVMQlFBRGdnRUJBS3pDc2hqNDQwWUhWaHR5OVhtNwpVYW45U0F5OUVtMXYvZDVEWm5BWTBiQkQrenNlSTFpaVlhTlZEVTRBUkRvM3hVMDlMbU9PSURBVTh0QWZJNnJaCjh5QUNiVFRyc0ZpN1dZN2VzTHZqY2lVRkozT2ZCZklnTi9NMkJzaVRvOHFGd1VNZkpHS0lCbG5GNjgwMzB2d3UKb1owckduU0syd2NKZkhPbCsyWFNRSnlPSjEvd0hxZUprUzhKRnk5T2RpNjcxTlRaQnhMenNycy8wVEVwV2hwTApJNytZRlZwNGZWWVZmbkFZSUtsbm5vVkRFL1VpZ0QwSGRYYVllZVdEVUlNb2lpVCtibXYvblNBL1JjWFNyV252Cjkra1RNVDJyVXNuNmVwT3ZzSW1DcGdGTlNTR0JHYkh4TDhCSVRQS01QSWxUa1hGejhmY2hFVm1CdmlvcHZNY1QKaEFvPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
    server: https://95.216.140.240:6443
  name: kubernetes
contexts:
- context:
    cluster: kubernetes
    user: piotr
  name: piotr@kubernetes
current-context: piotr@kubernetes
kind: Config
preferences: {}
users:
- name: piotr
  user:
    client-certificate-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURURENDQWpTZ0F3SUJBZ0lSQUlRZDBibU52Y01lYXcvSzkwNUgza1F3RFFZSktvWklodmNOQVFFTEJRQXcKRlRFVE1CRUdBMVVFQXhNS2EzVmlaWEp1WlhSbGN6QWVGdzB5TWpBM01UTXhPRE0wTWpaYUZ3MHlNakEzTVRReApPRE0wTWpaYU1HWXhDekFKQmdOVkJBWVRBbEJNTVJBd0RnWURWUVFJRXdkc2IyUjZhMmxsTVEwd0N3WURWUVFICkV3Uk1iMlI2TVJJd0VBWURWUVFLRXdsa1pYWmxiRzl3WlhJeEVqQVFCZ05WQkFzVENXUmxkbVZzYjNCbGNqRU8KTUF3R0ExVUVBeE1GY0dsdmRISXdnZ0VpTUEwR0NTcUdTSWIzRFFFQkFRVUFBNElCRHdBd2dnRUtBb0lCQVFDOQovZDJJK3ZYR0ZLWThxaDRPOTcwOWg2RFFoRWNXOFlQL2o1Zm5jbm5JQkgwMi9MMGdlUndITEVCNDQ5ai9YdnFvCmxtTzhnemRianFDajRwaGY3aEZURENUeXVUKzFpM0N4MkE2Ym03UU1TTWhTUjBxcENnTVU5dDJkTms1c3N6Ry8KWnpEM2p1R0RSWHBTYlJ6cDladExoblhXQWlvcEp0VlUxMFJLNTNmZkl0RElabVkxbDlhZTRwQmdYSlNpTzB4agoycmhiKzRYYW1CMTVDdEt2eXBzZjFEVzJKU01NeHhhQjY0M0Fka0dMM0hXWGlCaHhxbnM4dFZGbzRzV0MxM2dsCndkOUxuOWVtZzQ4dFJ6OWczSVM2MDZvVFVLODVLNmgxdXhGdktTckU3MjIyeThWT1RqZUZhS2w4ZlgyUURqNS8KZFJmSVFQVWFTQ3E4UGtENDF6eHpBZ01CQUFHalJqQkVNQk1HQTFVZEpRUU1NQW9HQ0NzR0FRVUZCd01DTUF3RwpBMVVkRXdFQi93UUNNQUF3SHdZRFZSMGpCQmd3Rm9BVXBRNzFyOW9FT3JVUnpJM2NDbytTdkltTjgrUXdEUVlKCktvWklodmNOQVFFTEJRQURnZ0VCQUIrYUlqN2VCMnN5T29IYUpiTWhZTDlHdGw1UU8rWXRoT2FicDd2ZHVTTFkKekpuNmpuRHRtQVFOTmt5SVFUbWdWcjBxYmg2RzIzeFhBUkppZFZ6TzRvUCtGbmF6TDhGeURWalA3anNONU1URgprbDFEdWQ5Y1FaSmVvQ3hGZHEzVkVRWVB3Nkx5azhwT0ZJbGhadEc4ZGYzVnJvUjc4amxqZWVUNHdOSTdNZFJRCklyTmpGYUEyc3lUUUF5c1V3aThYSE1qeHdaajFTYTZWSXlDdHBJbnFjMHFpUkQwQllZK0pXd3d1ZFBnYitLcmUKLzdwam5oWkx6a2ZDeUpKaWM5VXkxbytkWGdqNE02UGp4OEtqOHREbHVJUnNVYTRnMkZKME9CbXY0eE0rZGtyMQp2ZnBXdkdTSnNCemc2N1NDZG9POGVtMTluUUlYbVY0akhXVjdmZ2FxZzJZPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
    client-key-data: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFcEFJQkFBS0NBUUVBdmYzZGlQcjF4aFNtUEtvZUR2ZTlQWWVnMElSSEZ2R0QvNCtYNTNKNXlBUjlOdnk5CklIa2NCeXhBZU9QWS8xNzZxSlpqdklNM1c0NmdvK0tZWCs0UlV3d2s4cmsvdFl0d3NkZ09tNXUwREVqSVVrZEsKcVFvREZQYmRuVFpPYkxNeHYyY3c5NDdoZzBWNlVtMGM2ZldiUzRaMTFnSXFLU2JWVk5kRVN1ZDMzeUxReUdabQpOWmZXbnVLUVlGeVVvanRNWTlxNFcvdUYycGdkZVFyU3I4cWJIOVExdGlVakRNY1dnZXVOd0haQmk5eDFsNGdZCmNhcDdQTFZSYU9MRmd0ZDRKY0hmUzUvWHBvT1BMVWMvWU55RXV0T3FFMUN2T1N1b2Ric1JieWtxeE85dHRzdkYKVGs0M2hXaXBmSDE5a0E0K2YzVVh5RUQxR2tncXZENUErTmM4Y3dJREFRQUJBb0lCQUVVV3hEREQwZ3d1QmlXWgpWMFRxSWc3MSt5elliV0dTZ2dXMUdmQTRXTUM3b1MwVnkxQzd1YzJCOGhBRUN5MFNST1I1aTl0SmZCLzNSY05TCjYwWTNOR1dXelBqWEZLdllBU3NxL21UbndobVZmZ010bWFETzIwQU1aWnA5M1JiNk11VC9pWGI4cGxVdU5zVXkKbUlrYm4xVmZtQW95ejFJWHBRd3RHOUNCUzc0QU1sRk8vYlFsUy8wSWlzejhFOE5YZEttVjBDMmxFTHc4SE4zRwpYNm90eU5Ca2ZRbzkyM0l6eXc0MGdDdWZQWXJMMGYyNzY4aFNiNFlSS2kyOUwwd2hWL1gyK1lzRzdSYU1KUUFuCkpwaE0wRG5MdXREUXVrSVBYMWNGbnRKc2VLTFNFYzJDUnpVNlpJUmRNSER0WmQ1aGpqKzJjNkFLK3JwenR2UWEKNGV5b0JRRUNnWUVBN0pGUHo5a0w1ZkFmYjd3c0hwdFdqMEZIRnlWWFFoalhVRE1Dc0h1RHdJb1RQNm93M1lFNQppb25rQ2lnM1JGUVlRczZ5Z2wzKzdNMFNsQTBmVTI0c0R6Vmt6N2VhOVBialI0WkZqclhvTk9PTytXMmhqbVlWCnJVUkE3NEFWWHpzYlZURXRKcGJobTFDdU9vOFl0c01hcHhrOUZLOUtJSGZxV2F6YVNPazNJU01DZ1lFQXpaa2cKT1FDbWFCdHIwY2ViUlNMZnF5bmF3ODdjcDhWbGNQV1AyaTlSNkVTcEEwdFh6eUJRZWZ5c3NzV0tRVzJpQitMbApIOGp0Q2xsSkJXSTNKVk9uSjdqR2JCdktpTk5HbkppR1l4TVNJQ2wzSzVJNWlVcWFrRTY2UTF5eDRlT1o5RU1QCjZ0d3Y2K0dHWkI2b1ZaVnhtNjZ5aFBZVzhNTTExNEhXQnBiSHRIRUNnWUVBcmZ5UmZvUmJROW0reFNiWUxBcUQKTndrRGgvcG1tcTQ2YlRtWEdNVSt1VFRUdzFjZ2FVakpVU0xwSEs5SE5uSERCaCtQR21LWFF3SHdVQUwycngydwpPZDlETGFJVHpXWm04Z3ZHekpidEdUamp4bjdpK3lBSmdVMVpsTXZXN0J0RWx2dDhBWTJtajl4ZXg2TEd3bVBzCkRrbDVxdVRnMTlCYUEyb2xnTXBGU1pFQ2dZQXZmOUlPK1ZSNHR1VVpDVG1aSm01d1YvSWZ6Tm56dE1vejU3ZTkKVzdOYnF3azFKcUg1eTJoc1ZuRDd1R0d4cmdlQ05PeGtoSUluSXV1WTM5RUh3YVRicTNmRUlFT1JpdVpFWllTZQp2Umd4OEFLRlFYb2pldVhzc3hPYlhuNEdSeFFaZDZqa3hNd1pmZmdUaDNXeW1CMHdMNU0wM3JuOEU4MkxwWVp4CjdVSGtNUUtCZ1FDMHA4VCtaa211azU3THBXUHZrS3RUSjdrSzZjcjZ4RlZORjMwOE5uRUxNNHpkZ2tQYmlLVmUKNUIxRTU4Q04zMVM2NmtnbHJZcnBobmxwRm9QY2RCT2tIczF5OXM0MnZoV0ZZMHRqRVVSYlVCRUJHZENwNDQrVAoyVTJNMEkzT3dkbE9QdzAvQzhFZEhILy9YdjVaalRGamJXd3RCaTRrdG1mZVJMVzBPME1UK3c9PQotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQo=


